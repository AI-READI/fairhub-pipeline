# Manifest Validation Script

This script validates the manifest data generated by `local_imaging_manifest.py`. It performs comprehensive checks to ensure data integrity and consistency.

## Features

### 1. Manifest Structure Validation

- Checks for required columns in each manifest type
- Validates manifest file existence and format
- Ensures proper TSV file structure

### 2. File Path Validation

- Verifies that all file paths in manifests point to existing files
- Handles both relative and absolute path formats
- Reports missing or inaccessible files

### 3. DICOM File Integrity

- Validates DICOM file headers and structure
- Checks for required DICOM tags (SOPInstanceUID, PatientID)
- Identifies corrupted or invalid DICOM files

### 4. Metadata Consistency

- Validates required fields are not null
- Checks for duplicate SOP Instance UIDs
- Validates manufacturer and imaging type consistency
- Ensures numeric fields contain valid numbers

### 5. Cross-Reference Validation

- Validates OCT references to photography files
- Checks OCTA references to both photography and OCT files
- Ensures UID consistency across manifests

## Usage

### Basic Usage

```bash
python validate_spectralis_manifests.py
```

### Custom Paths

```bash
python validate_spectralis_manifests.py --input-folder /path/to/data --manifest-folder /path/to/manifests
```

### Verbose Output

```bash
python validate_spectralis_manifests.py --verbose
```

### Command Line Options

- `--input-folder`: Path to input data folder (default: `C:\Users\sanjay\Downloads\Spectralis-processed`)
- `--manifest-folder`: Path to manifest output folder (default: `C:\Users\sanjay\Downloads\Spectralis-manifests`)
- `--verbose`: Enable detailed logging and error reporting

## Expected Manifest Structure

### Retinal Photography Manifest

Required columns:

- `person_id`, `manufacturer`, `manufacturers_model_name`
- `laterality`, `anatomic_region`, `imaging`
- `height`, `width`, `color_channel_dimension`
- `sop_instance_uid`, `filepath`

### Retinal OCT Manifest

Required columns:

- `person_id`, `manufacturer`, `manufacturers_model_name`
- `anatomic_region`, `imaging`, `laterality`
- `height`, `width`, `number_of_frames`
- `pixel_spacing`, `slice_thickness`
- `sop_instance_uid`, `filepath`
- `reference_instance_uid`, `reference_filepath`

### Retinal OCTA Manifest

Required columns:

- `person_id`, `manufacturer`, `manufacturers_model_name`
- `anatomic_region`, `imaging`, `laterality`
- `flow_cube_height`, `flow_cube_width`, `flow_cube_number_of_frames`
- `flow_cube_sop_instance_uid`, `flow_cube_file_path`

## Validation Checks

### File System Checks

- ✅ Input folder exists
- ✅ Manifest folder exists
- ✅ Manifest files exist and are readable
- ✅ All referenced files exist on disk

### DICOM File Checks

- ✅ DICOM files are valid and readable
- ✅ Required DICOM tags are present
- ✅ SOP Instance UIDs are unique
- ✅ Patient IDs are consistent

### Metadata Checks

- ✅ Required fields are not null
- ✅ Manufacturer is "Heidelberg"
- ✅ Imaging types are correct (IR, OCT, OCTA)
- ✅ Numeric fields contain valid numbers
- ✅ No duplicate SOP Instance UIDs

### Cross-Reference Checks

- ✅ OCT files reference valid photography files
- ✅ OCTA files reference valid photography and OCT files
- ✅ UID consistency across all manifests

## Output

The script provides detailed output including:

### Statistics

- Number of files processed
- Number of valid/invalid files
- Number of errors and warnings

### Error Reporting

- ❌ Critical errors that prevent processing
- ⚠️ Warnings for potential issues
- Detailed error messages with file paths and row numbers

### Summary

- ✅ Overall validation status
- Count of errors and warnings
- Final pass/fail status

## Exit Codes

- `0`: All validations passed
- `1`: Validation failed with errors

## Example Output

```bash
============================================================
VALIDATION SUMMARY
============================================================

Statistics:
  retinal_photography_rows: 150
  retinal_photography_valid_files: 150
  retinal_photography_valid_dicom: 150
  retinal_oct_rows: 75
  retinal_oct_valid_files: 75
  retinal_oct_valid_dicom: 75
  retinal_octa_rows: 25
  retinal_octa_valid_files: 25
  retinal_octa_valid_dicom: 25

✓ No errors found
✓ No warnings found

✅ VALIDATION PASSED: All checks completed successfully
```

## Integration

This validation script is designed to work with the output of `local_imaging_manifest.py`. Run the validation after generating manifests to ensure data quality and integrity.

## Troubleshooting

### Common Issues

1. **Missing folders**: Ensure input and manifest folders exist
2. **File not found**: Check file paths in manifests are correct
3. **DICOM errors**: Verify DICOM files are not corrupted
4. **Cross-reference errors**: Ensure all related manifests are generated

### Debug Mode

Use `--verbose` flag for detailed error reporting and file-by-file validation results.
